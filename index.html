<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>駕駛信用評分系統 - ES912</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 內部樣式，用於 loading 狀態 */
        .loading {
            opacity: 0.6;
            /* 淡化效果 */
            pointer-events: none;
            /* 禁用點擊 */
        }

        .loading-indicator {
            text-align: center;
            margin-top: 20px;
            font-size: 1.2em;
            color: var(--secondary-color);
        }
    </style>
</head>

<body>
    <header class="site-header">
        <img src="images/t.jpg" alt="駕駛信用評分系統" class="header-img">
    </header>
    <main>
        <table class="driver-info-table">
            <thead>
                <tr>
                    <th colspan="6" class="main-title">駕駛信用評分系統</th>
                    </tr>
            </thead>
            <tbody id="table-body">
                <tr>
                    <td colspan="2" class="image-cell" rowspan="3">
                        <div class="cell-label">汽車圖片</div>
                        <img id="CarImg" src="images/car.jpg" alt="汽車圖片">
                    </td>
                    <td colspan="2" class="image-cell" rowspan="3">
                        <div class="cell-label">駕駛人圖片</div>
                        <img id="DriverImg" src="images/person.jpg" alt="駕駛人圖片">
                    </td>
                    <td class="score-cell" colspan="2">
                        <span class="score-label">總評分</span>
                        <span id="Point">--</span>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" class="log-label-cell">
                        <span class="log-label">記錄日誌</span>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <ul class="scrollable-list">
                            <li id="log1"></li>
                            <li id="log2"></li>
                            <li id="log3"></li>
                            <li id="log4"></li>
                            <li id="log5"></li>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <td class="label-cell">汽車款式型號</td>
                    <td class="data-cell"><span id="CarBrand">---</span></td>
                    <td class="label-cell">駕駛人身分證</td>
                    <td class="data-cell"><span id="DriverID">---</span></td>
                </tr>
                <tr>
                    <td class="label-cell">汽車車牌號</td>
                    <td class="data-cell"><span id="LicensePlate">---</span></td>
                    <td class="label-cell">駕駛人生日</td>
                    <td class="data-cell"><span id="DriverBirthday">---</span></td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="6">
                        <table class="violation-summary-table">
                            <thead>
                                <tr>
                                    <th colspan="3" class="category-header">違規次數</th>
                                    <th colspan="3" class="category-header">駕駛狀態檢測</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="violation-name">車距過近</td>
                                    <td class="violation-count"><span id="TooClose">0</span> 次</td>
                                    <td class="violation-name">壓車道線</td>
                                    <td class="violation-count"><span id="LanePressingLine">0</span> 次</td>
                                    <td class="violation-name">分心</td>
                                    <td class="violation-count"><span id="Distractions">0</span> 次</td>
                                </tr>
                                <tr>
                                    <td class="violation-name">打瞌睡</td>
                                    <td class="violation-count"><span id="Nod">0</span> 次</td>
                                    <td class="violation-name">使用手機</td>
                                    <td class="violation-count"><span id="UsingMobilePhone">0</span> 次</td>
                                    <td class="violation-name">抽菸</td>
                                    <td class="violation-count"><span id="Smoke">0</span> 次</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
            </tfoot>
        </table>
        <div id="loading-text" class="loading-indicator">資料載入中...</div>
        </main>
    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import {
            getDatabase,
            ref as dbRef,
            onValue
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
        import {
            getStorage,
            ref as storageRef,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCK4juwHIRyHmWx5wrZXb2uxLKJoeZ0cdw",
            authDomain: "drivingcreditscoringsystem.firebaseapp.com",
            databaseURL: "https://drivingcreditscoringsystem-default-rtdb.firebaseio.com",
            projectId: "drivingcreditscoringsystem",
            storageBucket: "drivingcreditscoringsystem.firebasestorage.app",
            messagingSenderId: "705137872436",
            appId: "1:705137872436:web:97058309dc0076f7e2c461"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        const refs = {
            CarBrand: document.getElementById("CarBrand"),
            LicensePlate: document.getElementById("LicensePlate"),
            DriverID: document.getElementById("DriverID"),
            DriverBirthday: document.getElementById("DriverBirthday"),
            Point: document.getElementById("Point"),
            TooClose: document.getElementById("TooClose"),
            LanePressingLine: document.getElementById("LanePressingLine"),
            Distractions: document.getElementById("Distractions"),
            Nod: document.getElementById("Nod"),
            UsingMobilePhone: document.getElementById("UsingMobilePhone"),
            Smoke: document.getElementById("Smoke"),
            CarImg: document.getElementById("CarImg"),
            DriverImg: document.getElementById("DriverImg"),
            logs: [1, 2, 3, 4, 5].map(i => document.getElementById(`log${i}`)),
            tableBody: document.getElementById("table-body"), //  表格 body
            loadingText: document.getElementById("loading-text") // Loading 指示器
        };

        function updateViolation(data) {
            ["TooClose", "LanePressingLine", "Distractions", "Nod", "UsingMobilePhone", "Smoke"].forEach(key => {
                refs[key].textContent = data.Violation ? .[key] || 0;
            });

            const logArr = data.Log ? .slice(-5).reverse() || [];
            refs.logs.forEach((el, i) => el.textContent = logArr[i] || "");
        }

        function showLoading(show) {
            // 顯示或隱藏 loading 效果
            refs.tableBody.classList.toggle('loading', show);
            refs.loadingText.style.display = show ? 'block' : 'none';
        }

        onValue(dbRef(db, `/ID/A123456789`), snap => {
            showLoading(true); // 開始載入時顯示

            if (!snap.exists()) {
                showLoading(false); // 載入失敗時隱藏
                console.error("No data found for /ID/A123456789");
                // 可以考慮在這裡顯示一個錯誤訊息給使用者
                return;
            }

            const d = snap.val();
            refs.CarBrand.textContent = d.CarBrand || '---';
            refs.LicensePlate.textContent = d.LicensePlate || '---';
            refs.DriverID.textContent = 'A123456789';
            refs.DriverBirthday.textContent = d.DriverBirthday || '---';
            refs.Point.textContent = d.Point ?? '--';

            (d.CarImgURL ?
                getDownloadURL(storageRef(storage, d.CarImgURL)).then(url => {
                    refs.CarImg.src = url;
                    showLoading(false); // 圖片載入完成後隱藏
                }).catch(error => {
                    console.error("Error fetching CarImgURL:", error);
                    refs.CarImg.src = 'images/car.jpg';
                    showLoading(false); // 載入失敗時隱藏
                }) :
                refs.CarImg.src = 'images/car.jpg'
            );

            (d.DriverImgURL ?
                getDownloadURL(storageRef(storage, d.DriverImgURL)).then(url => {
                    refs.DriverImg.src = url;
                    showLoading(false); // 圖片載入完成後隱藏
                }).catch(error => {
                    console.error("Error fetching DriverImgURL:", error);
                    refs.DriverImg.src = 'images/person.jpg';
                    showLoading(false); // 載入失敗時隱藏
                }) :
                refs.DriverImg.src = 'images/person.jpg'
            );

            updateViolation(d);
            showLoading(false); // 資料載入完成後隱藏
        }, (error) => {
            showLoading(false); // 發生錯誤時隱藏
            console.error("Error fetching data:", error);
            // 處理錯誤，例如顯示錯誤訊息給使用者
        });
    </script>
</body>

</html>