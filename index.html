<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>駕駛信用評分系統 - ES912</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 主容器 */
        .container {
            max-width: 960px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px var(--shadow-color);
        }
        /* 橫幅 */
        .site-header { margin-bottom: 20px; }
        .header-img { width: 100%; height: auto; display: block; border-radius: var(--border-radius); }
        /* 首區: 圖片 + 分數+日誌 */
        .top-section {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .image-card, .score-box, .log-box {
            background: var(--light-gray);
            border-radius: var(--border-radius);
            padding: 10px;
            text-align: center;
        }
        .image-card span { display: block; margin-bottom: 8px; font-weight: 500; }
        .image-card img { width: 100%; height: auto; border-radius: var(--border-radius); }
        .score-box { display: flex; flex-direction: column; justify-content: center; }
        .score-box .score-label { font-size: 1.2em; margin-bottom: 8px; }
        .score-box #Point { font-size: 2.5em; color: var(--danger-color); }
        .log-box { position: relative; }
        .log-box .log-label { display: block; font-weight: 600; margin-bottom: 8px; }
        .scrollable-list { width: 100%; max-height: 200px; overflow-y: auto; background: #fff; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--border-radius); }
        .scrollable-list li { margin-bottom: 6px; padding: 6px; background: #e9ecef; border-radius: calc(var(--border-radius) * 0.8); }
        /* 中區: 資訊欄 */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .info-item { background: var(--light-gray); padding: 10px; border-radius: var(--border-radius); text-align: center; }
        .info-item span { display: block; }
        /* 下區: 違規摘要 */
        .violations {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .violations table { width: 100%; border-collapse: collapse; }
        .violations th { background: var(--light-gray); padding: 10px; }
        .violations td { padding: 10px; text-align: center; }
    </style>
</head>

<body>
    <div class="container">
        <!-- 橫幅 -->
        <header class="site-header">
            <img src="images/0.jpg" alt="駕駛信用評分系統" class="header-img">
        </header>

        <!-- 載入提示 -->
        <div id="loading-text" class="loading-indicator">資料載入中...</div>

        <!-- 首區: 汽車/駕駛圖片 + 分數 + 日誌 -->
        <section class="top-section">
            <div class="image-card">
                <span>汽車圖片</span>
                <img id="CarImg" src="images/car.jpg" alt="汽車圖片">
            </div>
            <div class="image-card">
                <span>駕駛人圖片</span>
                <img id="DriverImg" src="images/person.jpg" alt="駕駛人圖片">
            </div>
            <div>
                <div class="score-box">
                    <span class="score-label">總評分</span>
                    <span id="Point">--</span>
                </div>
                <div class="log-box">
                    <span class="log-label">記錄日誌</span>
                    <ul class="scrollable-list">
                        <li id="log1"></li>
                        <li id="log2"></li>
                        <li id="log3"></li>
                        <li id="log4"></li>
                        <li id="log5"></li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- 中區: 基本資訊 -->
        <section class="info-grid">
            <div class="info-item"><strong>汽車款式型號</strong><span id="CarBrand">---</span></div>
            <div class="info-item"><strong>汽車車牌號</strong><span id="LicensePlate">---</span></div>
            <div class="info-item"><strong>駕駛人身分證</strong><span id="DriverID">---</span></div>
            <div class="info-item"><strong>駕駛人生日</strong><span id="DriverBirthday">---</span></div>
        </section>

        <!-- 下區: 違規次數 & 狀態檢測 -->
        <section class="violations">
            <table>
                <thead><tr><th colspan="2">違規次數</th></tr></thead>
                <tbody>
                    <tr><td>車距過近</td><td><span id="TooClose">0</span> 次</td></tr>
                    <tr><td>壓車道線</td><td><span id="LanePressingLine">0</span> 次</td></tr>
                </tbody>
            </table>
            <table>
                <thead><tr><th colspan="2">駕駛狀態檢測</th></tr></thead>
                <tbody>
                    <tr><td>分心</td><td><span id="Distractions">0</span> 次</td></tr>
                    <tr><td>打瞌睡</td><td><span id="Nod">0</span> 次</td></tr>
                    <tr><td>使用手機</td><td><span id="UsingMobilePhone">0</span> 次</td></tr>
                    <tr><td>抽菸</td><td><span id="Smoke">0</span> 次</td></tr>
                </tbody>
            </table>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getDatabase, ref as dbRef, onValue } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
        import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCK4juwHIRyHmWx5wrZXb2uxLKJoeZ0cdw",
            authDomain: "drivingcreditscoringsystem.firebaseapp.com",
            databaseURL: "https://drivingcreditscoringsystem-default-rtdb.firebaseio.com",
            projectId: "drivingcreditscoringsystem",
            storageBucket: "drivingcreditscoringsystem.firebasestorage.app",
            messagingSenderId: "705137872436",
            appId: "1:705137872436:web:97058309dc0076f7e2c461"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        const refs = {
            CarBrand: document.getElementById("CarBrand"),
            LicensePlate: document.getElementById("LicensePlate"),
            DriverID: document.getElementById("DriverID"),
            DriverBirthday: document.getElementById("DriverBirthday"),
            Point: document.getElementById("Point"),
            TooClose: document.getElementById("TooClose"),
            LanePressingLine: document.getElementById("LanePressingLine"),
            Distractions: document.getElementById("Distractions"),
            Nod: document.getElementById("Nod"),
            UsingMobilePhone: document.getElementById("UsingMobilePhone"),
            Smoke: document.getElementById("Smoke"),
            CarImg: document.getElementById("CarImg"),
            DriverImg: document.getElementById("DriverImg"),
            logs: [1,2,3,4,5].map(i => document.getElementById(`log${i}`)),
            loadingText: document.getElementById("loading-text"),
            dataTable: document.getElementById("data-table")
        };

        function updateViolation(data) {
            ["TooClose","LanePressingLine","Distractions","Nod","UsingMobilePhone","Smoke"].forEach(key => {
                refs[key].textContent = data.Violation?.[key] ?? 0;
            });
            const arr = data.Log?.slice(-5).reverse() ?? [];
            refs.logs.forEach((el,i) => el.textContent = arr[i] || '');
        }

        function setLoading(show) {
            refs.dataTable.classList.toggle('loading', show);
            refs.loadingText.style.display = show ? 'block' : 'none';
        }

        const driverID = 'A123456789';
        setLoading(true);
        onValue(dbRef(db, `/ID/${driverID}`), snap => {
            setLoading(false);
            if (!snap.exists()) return;
            const data = snap.val();
            refs.CarBrand.textContent = data.CarBrand || '---';
            refs.LicensePlate.textContent = data.LicensePlate || '---';
            refs.DriverID.textContent = driverID;
            refs.DriverBirthday.textContent = data.DriverBirthday || '---';
            refs.Point.textContent = data.Point ?? '--';

            if (data.CarImgURL) {
                getDownloadURL(storageRef(storage, data.CarImgURL))
                    .then(url => refs.CarImg.src = url)
                    .catch(() => refs.CarImg.src = 'images/car.jpg');
            }
            if (data.DriverImgURL) {
                getDownloadURL(storageRef(storage, data.DriverImgURL))
                    .then(url => refs.DriverImg.src = url)
                    .catch(() => refs.DriverImg.src = 'images/person.jpg');
            }

            updateViolation(data);
        }, err => {
            setLoading(false);
            console.error('Firebase error:', err);
        });
    </script>
</body>

</html>